generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  // âœ… Billing / Invoice Profile
  businessName String? // si quieren facturar con un nombre distinto
  email        String?
  phone        String?
  website      String?
  logoUrl      String?
  // Recurring defaults
  recurringFrequency    String?
  recurringDueDays      Int?
  recurringReminderDays String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zip          String?
  country      String?

  memberships   Membership[]
  customers     Customer[]
  sales         Sale[]
  payments      Payment[]
  products      Product[]
  saleItems     SaleItem[]
  estimates     Estimate[]
  estimateItems EstimateItem[]

  emailLogs EmailLog[]
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String?
  isSuperAdmin       Boolean  @default(false)
  passwordHash       String?
  mustChangePassword Boolean  @default(false)
  createdAt          DateTime @default(now())

  memberships         Membership[]
  sessions            AuthSession[]
  passwordResetTokens PasswordResetToken[]
}

model Membership {
  id             String @id @default(cuid())
  organizationId String
  userId         String

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  role      Role     @default(STAFF)
  createdAt DateTime @default(now())

  @@unique([organizationId, userId])
  @@unique([userId])
}

model MagicLinkToken {
  id        String   @id @default(cuid())
  email     String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model AuthSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Customer {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  fullName    String
  phone       String?
  homeAddress String?
  workAddress String?
  email       String?
  reference   String?
  notes       String?

  createdAt DateTime @default(now())

  sales     Sale[]
  estimates Estimate[]
}

model Sale {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  publicToken    String? @unique
  description    String
  poNumber       String?
  serviceAddress String?
  notes          String?

  subtotalAmount Decimal @default(0)
  discountAmount Decimal @default(0)
  taxRate        Decimal @default(0) // porcentaje, ej 6.625
  taxAmount      Decimal @default(0)
  totalAmount    Decimal @db.Decimal(10, 2)
  paidAmount     Decimal @default(0) @db.Decimal(10, 2)
  balanceAmount  Decimal @default(0) @db.Decimal(10, 2)

  saleDate DateTime   @default(now())
  dueDate  DateTime?
  status   SaleStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments  Payment[]
  items     SaleItem[]
  emailLogs EmailLog[]

  estimate Estimate?
}

model SaleItem {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  name      String
  type      ProductType
  quantity  Int         @default(1)
  unitPrice Decimal     @db.Decimal(10, 2)
  lineTotal Decimal     @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([saleId])
}

model Payment {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  amount Decimal       @db.Decimal(10, 2)
  method PaymentMethod @default(CASH)
  paidAt DateTime      @default(now())
  notes  String?

  createdAt DateTime @default(now())
}

model Product {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name        String
  type        ProductType
  description String?
  price       Decimal?    @db.Decimal(10, 2)
  active      Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  salesItems    SaleItem[]
  estimateItems EstimateItem[]

  @@index([organizationId])
}

model Estimate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  title       String
  description String?
  notes       String?

  poNumber       String?
  serviceAddress String?

  subtotalAmount Decimal @default(0)
  discountAmount Decimal @default(0)
  taxRate        Decimal @default(0)
  taxAmount      Decimal @default(0)
  taxPercent     Decimal @default(0)
  totalAmount    Decimal @db.Decimal(10, 2)

  status     EstimateStatus @default(DRAFT)
  validUntil DateTime?

  publicToken String?   @unique
  lastSentAt  DateTime?
  lastSentTo  String?
  sentCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  saleId String? @unique
  sale   Sale?   @relation(fields: [saleId], references: [id])

  items     EstimateItem[]
  emailLogs EmailLog[]
}

model EstimateItem {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  name      String
  type      ProductType
  quantity  Int
  unitPrice Decimal     @db.Decimal(10, 2)
  lineTotal Decimal     @db.Decimal(10, 2)

  createdAt DateTime @default(now())
}

model EmailLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  estimateId String?
  estimate   Estimate? @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  to      String
  subject String?
  status  EmailStatus
  error   String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([estimateId])
  @@index([saleId])
}

enum EstimateStatus {
  DRAFT
  SENT
  APPROVED
  EXPIRED
}

enum ProductType {
  PRODUCT
  SERVICE
}

enum Role {
  OWNER
  ADMIN
  STAFF
}

enum SaleStatus {
  PENDING
  PAID
  OVERDUE
}

enum PaymentMethod {
  CASH
  ZELLE
  CARD
  CHECK
  OTHER
}

enum EmailStatus {
  SENT
  FAILED
}
